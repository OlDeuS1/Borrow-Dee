{% extends "layouts/layout.html" %}
{% load static %}

{% block title %} {{ book.title }} {% endblock %}

{% block header %}
    {% include "layouts/navigation.html" %}
{% endblock %}

{% block content %}
    <div class="book-detail max-w-[80rem] w-full mx-auto flex gap-10 py-20 h-screen">
        <img src="{% if book.image %}{{ book.image }}{% else %}{% static 'images/No_image_available.svg' %}{% endif %}" alt="{{ book.title }}" class="book-detail__img max-h-[30rem]">
        <div class="book-detail__content">
            <h1 class="text-[3.2rem]">{{ book.title }}</h1>
            <div class="book-detail-rating text-[#E07A5F] mb-6">Rating : {{ book.avg_rating }}</div>
            <div class="book-detail-authors"><strong class="font-semibold">Authors : </strong>{{ book.author.all|join:", " }}</div>
            <div class="book-detail-categories"><strong class="font-semibold">Categories : </strong>{{ book.category.all|join:", " }}</div>
            <div class="book-detail-publish"><strong class="font-semibold">Publish Date : </strong>{{ book.published_date|date:"d F, Y" }}</div>
            <div class="book-detail-copies mb-6"><strong class="font-semibold">Copies Avaliable : </strong>{% if book.copies_available < 1 %}0{% else %}{{ book.copies_available  }}{% endif %}</div>
            <div class="book-detail-description"><strong class="font-semibold">Detail : </strong><br>{{ book.description }}</div>
            {% if user.is_authenticated %}
                {% if borrowed %}
                    <button disabled class="btn-borrowing inline-block mt-14 px-10 py-2 bg-gray-500 text-white rounded-[3rem] transition-all shadow-xl">
                        Borrowing
                    </button>
                {% elif reserved %}
                    <button disabled class="btn-reserving inline-block mt-14 px-10 py-2 bg-gray-500 text-white rounded-[3rem] transition-all shadow-xl">
                        Reserving
                    </button>
                {% elif book.copies_available > 0 %}
                    <button data-book="{{ book.id }}" class="btn-borrow cursor-pointer inline-block mt-14 px-10 py-2 bg-[#A9907E] text-white rounded-[3rem] transition-all hover:bg-[#8c7869] shadow-xl">
                        Borrow
                    </button>
                {% else %}
                    <button data-book="{{ book.id }}" class="btn-reserve cursor-pointer inline-block mt-14 px-10 py-2 bg-white border-2 border-[#403d39] text-[#403D39] rounded-[3rem] transition-all hover:bg-gray-200 shadow-xl">Reserve</button>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% endblock %}
{% block script %} 
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const btnBorrow = document.querySelector('.btn-borrow');
            const btnReserve = document.querySelector('.btn-reserve')

            if(btnBorrow) {
                btnBorrow.addEventListener('click', async () => {
                    const bookId = btnBorrow.dataset.book
                    const csrftoken = document.cookie.split('=').at(-1)
                    const borrowData = {"book": Number(bookId)}

                    try {
                        const res = await fetch('http://127.0.0.1:8000/library/api/borrows/', {
                            method: "POST",
                            headers: { 
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': csrftoken,
                                    },
                            body: JSON.stringify(borrowData),
                        })

                        if(res.ok)
                            window.location.href = "{% url 'myborrows' %}"
                    } catch (err) {
                        alert(err.message)
                        console.error(err.message);
                    }
                })
            }

            if(btnReserve) {
                btnReserve.addEventListener('click', async () => {
                    const bookId = btnReserve.dataset.book
                    const csrftoken = document.cookie.split('=').at(-1)
                    const reserveData = {"book": Number(bookId)}

                    try {
                        const res = await fetch('http://127.0.0.1:8000/library/api/reservations/', {
                            method: "POST",
                            headers: { 
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': csrftoken,
                                    },
                            body: JSON.stringify(reserveData),
                        })

                        if(res.ok)
                            window.location.href = "{% url 'myreservations' %}"
                    } catch (err) {
                        alert(err.message)
                        console.error(err.message);
                    }
                })
            }
        })
    </script>
{% endblock %}
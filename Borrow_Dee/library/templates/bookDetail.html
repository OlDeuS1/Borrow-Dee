{% extends "layouts/layout.html" %}
{% load static %}

{% block title %} {{ book.title }} {% endblock %}

{% block header %}
    {% include "layouts/navigation.html" %}
{% endblock %}

{% block content %}
    <div class="book-detail max-w-[80rem] w-full mx-auto flex gap-10 py-20">
        <img src="{% if book.image %}{{ book.image.url }}{% else %}{% static 'images/No_image_available.svg' %}{% endif %}" alt="{{ book.title }}" class="book-detail__img max-h-[30rem]">
        <div class="book-detail__content">
            <h1 class="text-[3.2rem]">{{ book.title }}</h1>
            <div class="book-detail-rating text-[#E07A5F] mb-6">Rating : {{ book.avg_rating }}</div>
            <div class="book-detail-authors"><strong class="font-semibold">Authors : </strong>{{ book.author.all|join:", " }}</div>
            <div class="book-detail-categories"><strong class="font-semibold">Categories : </strong>{{ book.category.all|join:", " }}</div>
            <div class="book-detail-publish"><strong class="font-semibold">Publish Date : </strong>{{ book.published_date|date:"d F, Y" }}</div>
            <div class="book-detail-copies mb-6"><strong class="font-semibold">Copies Avaliable : </strong>{{ book.copies_available }}</div>
            <div class="book-detail-description"><strong class="font-semibold">Detail : </strong><br>{{ book.description }}</div>
            {% if user.is_authenticated %}
                {% if borrowed %}
                    <button disabled class="btn-borrowing inline-block mt-14 px-10 py-2 bg-gray-500 text-white rounded-[3rem] transition-all shadow-xl">
                        Borrowing
                    </button>
                {% elif reserved %}
                    <button disabled class="btn-reserving inline-block mt-14 px-10 py-2 bg-gray-500 text-white rounded-[3rem] transition-all shadow-xl">
                        Reserving
                    </button>
                {% elif book.copies_available > 0 %}
                    <button data-book="{{ book.id }}" data-fetchurl="{% url 'borrow-list' %}" data-redirecturl="{% url 'myborrows' %}" class="btn-borrow cursor-pointer inline-block mt-14 px-10 py-2 bg-[#A9907E] text-white rounded-[3rem] transition-all hover:bg-[#8c7869] shadow-xl">
                        Borrow
                    </button>
                {% else %}
                    <button data-book="{{ book.id }}" data-fetchurl="{% url 'reservation-list' %}" data-redirecturl="{% url 'myreservations' %}" class="btn-reserve cursor-pointer inline-block mt-14 px-10 py-2 bg-white border-2 border-[#403d39] text-[#403D39] rounded-[3rem] transition-all hover:bg-gray-200 shadow-xl">Reserve</button>
                {% endif %}
            {% endif %}
        </div>
    </div>
    <div class="reviews max-w-[80rem] w-full mx-auto flex flex-col gap-8 pt-8 pb-20">
        <div class="reviews__title text-[2.6rem] mb-4">
            Reviews
        </div>
        {% if reviews.count %}
            <div class="review__list flex flex-col gap-14">
                {% for review in reviews %}
                    <div class="review__item bg-[#403D39] text-white p-8 rounded-[2.5rem] shadow-xl flex flex-col gap-8">
                        <div class="review__header flex items-center gap-4">
                            <div class="user-icon rounded-[50%] border border-gray-500 p-4">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#fff" viewBox="0 0 256 256">
                                    <path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path>
                                </svg>
                            </div>
                            <div class="user-review">
                                <div class="username flex gap-4 justify-center items-center">
                                    {{ review.member }}
                                    <div class="user-review__date text-[1.4rem]">â€¢ &nbsp;{{ review.create_at|date:"d F, Y" }}</div>
                                </div>
                                <div class="user-rating text-[1.4rem] text-[#E07A5F]">Rating : {{ review.score }}</div>
                            </div>
                        </div>
                        <div class="review__comment bg-[#5D5953] px-5 pt-2 py-6 rounded-[1rem]">{% if review.comment %}{{ review.comment }}{% else %}<span class="text-gray-300">No comment.{% endif %}</span></div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-gray-500 text-center">No reviews yet.</div>
        {% endif %}
    </div>
{% endblock %}
{% block script %} 
    <script>
        const handleAction = async function(e){
            const csrftoken = "{{ csrf_token }}"
            const bodyData = {"book": Number(e.target.dataset.book)}

            try {
                const res = await fetch(e.target.dataset.fetchurl, {
                    method: "POST",
                    headers: { 
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrftoken,
                            },
                    body: JSON.stringify(bodyData),
                })

                if(res.ok)
                    window.location.href = e.target.dataset.redirecturl

                else {
                    alert(await res.json())
                    console.error(await res.json());
                }  

             } catch (err) {
                alert(err.message)
                console.error(err.message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const btnBorrow = document.querySelector('.btn-borrow');
            const btnReserve = document.querySelector('.btn-reserve')

            if(btnBorrow){
                btnBorrow.addEventListener('click', (e) => handleAction(e))
            }

            if(btnReserve){
                btnReserve.addEventListener('click', (e) => handleAction(e))
            }
        })
    </script>
{% endblock %}
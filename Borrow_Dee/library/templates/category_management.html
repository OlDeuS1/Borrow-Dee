{% extends 'layouts/admin_base.html' %}
{% block title %}Category Management{% endblock %}
{% block sidebar %}
	{% with active_section='categories' %}
		{% include 'layouts/admin_sidebar.html' %}
	{% endwith %}
{% endblock %}
{% block header %}
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 mb-10">
	<h1 class="text-4xl font-bold text-white">Category Management</h1>
	<div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
		<form action="{% url 'category_management' %}" method="GET" class="relative flex-1 min-w-[260px]">
			<input name="search" id="search" value="{{ request.GET.search }}" type="text" placeholder="Search categories..." class="search-input pr-12" />
			<button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">üîç</button>
		</form>
		<button onclick="openAddModal()" class="view-more-btn px-8 py-3 text-white font-medium flex items-center justify-center gap-2">
			<span class="text-lg leading-none">Ôºã</span> Add Category
		</button>
	</div>
</div>
{% endblock %}
{% block content %}
<div class="dashboard-card p-8">
	<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 divider pb-4">
		<h2 class="text-2xl font-semibold text-white">Categories List</h2>
		<div class="flex gap-2 text-sm text-gray-400">
			<span><strong class="text-white">{{ category_total }}</strong> total</span>
		</div>
	</div>
	<div class="overflow-x-auto -mx-4 md:mx-0">
		<table class="min-w-full text-sm text-left">
			<thead class="text-gray-400 uppercase text-xs tracking-wider">
				<tr class="border-b border-gray-600/40">
					<th class="py-3 px-6 font-medium w-16">No.</th>
					<th class="py-3 px-6 font-medium w-1/3">Name</th>
					<th class="py-3 px-6 font-medium w-32 text-center">Books Count</th>
					<th class="py-3 px-6 font-medium text-right w-32">Actions</th>
				</tr>
			</thead>
			<tbody class="text-gray-200">
				{% if categories|length > 0 %}
					{% for category in categories %}
					<tr class="table-row border-b border-gray-700/40 last:border-none">
						<td class="px-6 py-4 align-middle text-gray-300">{{ forloop.counter }}</td>
						<td class="px-6 py-4 font-semibold align-middle text-white">{{ category.name }}</td>
						<td class="px-6 py-4 align-middle text-center">{{ category.book_set.count }}</td>
						<td class="px-6 py-4 align-middle text-right whitespace-nowrap">
							<a href="{% url 'category_management' %}?edit_id={{ category.id }}" class="action-btn text-yellow-400 hover:text-yellow-300 mr-3" title="Edit">‚úèÔ∏è</a>
							<button class="action-btn text-red-500 hover:text-red-400 delete-btn" 
									data-category-id="{{ category.id }}" 
									data-category-name="{{ category.name }}"
									data-delete-url="{% url 'category-delete' category.id %}"
									title="Delete">üóëÔ∏è</button>
						</td>
					</tr>
					{% endfor %}
				{% else %}
				<tr>
					<td colspan="4" class="text-center text-gray-400 py-8">No categories found.</td>
				</tr>
				{% endif %}
			</tbody>
		</table>
	</div>
</div>

<div id="addModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
	<div class="bg-[#2D2D2D] rounded-3xl p-8 max-w-md w-full mx-4 relative shadow-2xl border border-gray-600/30">
		<!-- Close Button -->
		<button onclick="closeAddModal()" class="absolute top-5 right-5 text-white/40 hover:text-white/60 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10">
			<svg width="16" height="16" viewBox="0 0 16 16" fill="none">
				<path d="M12.8536 4.85355C13.0488 4.65829 13.0488 4.34171 12.8536 4.14645C12.6583 3.95118 12.3417 3.95118 12.1464 4.14645L8 8.29289L3.85355 4.14645C3.65829 3.95118 3.34171 3.95118 3.14645 4.14645C2.95118 4.34171 2.95118 4.65829 3.14645 4.85355L7.29289 9L3.14645 13.1464C2.95118 13.3417 2.95118 13.6583 3.14645 13.8536C3.34171 14.0488 3.65829 14.0488 3.85355 13.8536L8 9.70711L12.1464 13.8536C12.3417 14.0488 12.6583 14.0488 12.8536 13.8536C13.0488 13.6583 13.0488 13.3417 12.8536 13.1464L8.70711 9L12.8536 4.85355Z" fill="currentColor" />
			</svg>
		</button>

		<div class="text-center">
			<h2 class="text-2xl font-bold text-white mb-6">Add New Category</h2>

			<form id="addCategoryForm" method="POST" action="{% url 'category_management' %}" class="space-y-4">
				{% csrf_token %}
				<div class="text-left">
					<label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-300 mb-2">Category Name</label>
					{{ form.name }}
					<div class="text-yellow-300 text-[1.4rem]">{{ form.name.errors }}</div>
				</div>
				
				<div class="flex gap-4 justify-center mt-8">
					<button type="button" onclick="closeAddModal()" class="px-8 py-3 rounded-full border-2 border-white/15 text-white hover:bg-white/10 transition-colors font-medium min-w-[84px]">
						Cancel
					</button>
					<button type="submit" class="px-8 py-3 rounded-full bg-[#4CFFA6] hover:bg-[#3DE68B] text-black transition-colors font-medium min-w-[84px]">
						Add
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div id="editModal" class="fixed inset-0 z-50 {% if edit_id %}flex{% else %}hidden{% endif %} items-center justify-center bg-black/50 backdrop-blur-sm">
	<div class="bg-[#2D2D2D] rounded-3xl p-8 max-w-md w-full mx-4 relative shadow-2xl border border-gray-600/30">
		<button onclick="closeEditModal()" class="absolute top-5 right-5 text-white/40 hover:text-white/60 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10">
			<svg width="16" height="16" viewBox="0 0 16 16" fill="none">
				<path d="M12.8536 4.85355C13.0488 4.65829 13.0488 4.34171 12.8536 4.14645C12.6583 3.95118 12.3417 3.95118 12.1464 4.14645L8 8.29289L3.85355 4.14645C3.65829 3.95118 3.34171 3.95118 3.14645 4.14645C2.95118 4.34171 2.95118 4.65829 3.14645 4.85355L7.29289 9L3.14645 13.1464C2.95118 13.3417 2.95118 13.6583 3.14645 13.8536C3.34171 14.0488 3.65829 14.0488 3.85355 13.8536L8 9.70711L12.1464 13.8536C12.3417 14.0488 12.6583 14.0488 12.8536 13.8536C13.0488 13.6583 13.0488 13.3417 12.8536 13.1464L8.70711 9L12.8536 4.85355Z" fill="currentColor" />
			</svg>
		</button>

		<div class="text-center">
			<h2 class="text-2xl font-bold text-white mb-6">Edit Category</h2>
			
			<form id="editCategoryForm" method="POST" action="{% url 'category_management' %}" class="space-y-4">
				{% csrf_token %}
				<input type="hidden" name="edit_category" value="{% if edit_id %}{{ edit_id }}{% endif %}">
				<div class="text-left">
					<label for="{{ edit_form.name.id_for_label }}" class="block text-sm font-medium text-gray-300 mb-2">Category Name</label>
					{{ edit_form.name }}
					<div class="text-yellow-300 text-[1.4rem]">{{ edit_form.name.errors }}</div>
				</div>
				
				<div class="flex gap-4 justify-center mt-8">
					<button type="button" onclick="closeEditModal()" class="px-8 py-3 rounded-full border-2 border-white/15 text-white hover:bg-white/10 transition-colors font-medium min-w-[84px]">
						Cancel
					</button>
					<button type="submit" class="px-8 py-3 rounded-full bg-[#4CFFA6] hover:bg-[#3DE68B] text-black transition-colors font-medium min-w-[84px]">
						Update
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
	<div class="bg-[#2D2D2D] rounded-3xl p-8 max-w-md mx-4 relative shadow-2xl border border-gray-600/30">
		<!-- Close Button -->
		<button id="closeModal"
			class="absolute top-5 right-5 text-white/40 hover:text-white/60 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10">
			<svg width="16" height="16" viewBox="0 0 16 16" fill="none">
				<path
					d="M12.8536 4.85355C13.0488 4.65829 13.0488 4.34171 12.8536 4.14645C12.6583 3.95118 12.3417 3.95118 12.1464 4.14645L8 8.29289L3.85355 4.14645C3.65829 3.95118 3.34171 3.95118 3.14645 4.14645C2.95118 4.34171 2.95118 4.65829 3.14645 4.85355L7.29289 9L3.14645 13.1464C2.95118 13.3417 2.95118 13.6583 3.14645 13.8536C3.34171 14.0488 3.65829 14.0488 3.85355 13.8536L8 9.70711L12.1464 13.8536C12.3417 14.0488 12.6583 14.0488 12.8536 13.8536C13.0488 13.6583 13.0488 13.3417 12.8536 13.1464L8.70711 9L12.8536 4.85355Z"
					fill="currentColor" />
			</svg>
		</button>

		<div class="text-center">
			<h2 class="text-2xl font-bold text-white mb-2">Are you sure?</h2>
			<p class="text-white/85 mb-6">
				The category "<span id="categoryName" class="font-semibold"></span>" will be deleted.
			</p>
			
			<div class="flex gap-4 justify-center">
				<button onclick="closeModal()" class="px-8 py-3 rounded-full border-2 border-white/15 text-white hover:bg-white/10 transition-colors font-medium min-w-[84px]">
					No
				</button>
				<button onclick="confirmDelete()" id="confirmDeleteBtn" class="px-8 py-3 rounded-full bg-red-500 hover:bg-red-600 text-white transition-colors font-medium min-w-[84px]">
					Yes
				</button>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function openAddModal() {
	document.getElementById('addModal').classList.remove('hidden');
	document.getElementById('addModal').classList.add('flex');
	document.getElementById('categoryName').focus();
}

function closeAddModal() {
	document.getElementById('addModal').classList.add('hidden');
	document.getElementById('addModal').classList.remove('flex');
	document.getElementById('addCategoryForm').reset();
}

// Close modal when clicking outside
document.getElementById('addModal').addEventListener('click', function(e) {
	if (e.target === this) {
		closeAddModal();
	}
});

// Edit Modal Functions
function closeEditModal() {
	// Redirect to category management without edit_id parameter
	window.location.href = "{% url 'category_management' %}";
}

// Close edit modal when clicking outside
var editModal = document.getElementById('editModal');
if (editModal && !editModal.classList.contains('hidden')) {
	editModal.addEventListener('click', function(e) {
		if (e.target === this) {
			closeEditModal();
		}
	});
}

// Delete Modal Functions
let currentDeleteUrl = '';
let currentCategoryId = '';

function openModal(categoryName, deleteUrl) {
	document.getElementById('categoryName').textContent = categoryName;
	currentDeleteUrl = deleteUrl;
	// Extract category ID from the delete URL
	const urlParts = deleteUrl.split('/');
	currentCategoryId = urlParts[urlParts.length - 2];
	document.getElementById('deleteModal').classList.remove('hidden');
	document.getElementById('deleteModal').classList.add('flex');
}

function closeModal() {
	document.getElementById('deleteModal').classList.add('hidden');
	document.getElementById('deleteModal').classList.remove('flex');
}

const handleDeleteCategory = async function (categoryId) {
	const csrftoken = "{{ csrf_token }}";
	const confirmBtn = document.getElementById('confirmDeleteBtn');
	const originalText = confirmBtn.textContent;
	
	// Disable button and show loading state
	confirmBtn.disabled = true;
	confirmBtn.textContent = 'Deleting...';
	confirmBtn.classList.add('opacity-75');
	
	try {
		const res = await fetch(`http://127.0.0.1:8000/library/api/categories/${categoryId}/`, {
			method: "DELETE",
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrftoken,
			},
		});

		if (res.ok) {
			location.reload();
		} else {
			const errorData = await res.json();
			alert(errorData.message || 'Error deleting category. Please try again.');
			console.log(errorData);
		}
	} catch (err) {
		alert(err.message);
		console.log(err.message);
	} finally {
		// Reset button state
		confirmBtn.disabled = false;
		confirmBtn.textContent = originalText;
		confirmBtn.classList.remove('opacity-75');
	}
};

async function confirmDelete() {
	await handleDeleteCategory(currentCategoryId);
}

// Simple event delegation for delete button
document.addEventListener('click', function(e) {
	if (e.target.classList.contains('delete-btn')) {
		openModal(e.target.dataset.categoryName, e.target.dataset.deleteUrl);
	}
});

// Close modal when clicking outside delete modal
document.getElementById('deleteModal').addEventListener('click', function(e) {
	if (e.target === this) {
		closeModal();
	}
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
	if (e.key === 'Escape') {
		closeAddModal();
		closeModal();
		var editModal = document.getElementById('editModal');
		if (editModal && !editModal.classList.contains('hidden')) {
			closeEditModal();
		}
	}
});
</script>
{% endblock %}

{% extends 'layouts/admin_base.html' %}
{% block title %}Reservation Management{% endblock %}
{% block sidebar %}
    {% with active_section='reservations' %}
        {% include 'layouts/admin_sidebar.html' %}
    {% endwith %}
{% endblock %}
{% block header %}
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 mb-10">
    <div>
        <h1 class="text-4xl font-bold text-white mb-4 lg:mb-2">Reservation Management</h1>
    </div>
    <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
        <form action="{% url 'reservation_management' %}" method="GET" class="relative flex-1 min-w-[260px]">
        <input type="text" name="search" value="{{ search_query }}" placeholder="Search user/book..."
            class="search-input pr-12" />
        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
    </form>
    </div>
</div>
{% endblock %}
{% block content %}

<div class="dashboard-card p-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 divider pb-4">
        <h2 class="text-2xl font-semibold text-white">Reservations List</h2>
        <div class="flex gap-2 text-sm text-gray-400">
            <span><strong class="text-white">{{ reserve_total }}</strong> total</span>
            <span class="hidden sm:inline">‚Ä¢</span>
            <span><strong class="text-yellow-300">{{ waiting_total }}</strong> waiting</span>
        </div>
    </div>
    <div class="overflow-x-auto -mx-4 md:mx-0">
        <table class="min-w-full text-sm text-left">
            <thead class="text-gray-400 uppercase text-xs tracking-wider">
                <tr class="border-b border-gray-600/40">
                    <th class="py-3 px-4 font-medium">No.</th>
                    <th class="py-3 px-4 font-medium">User</th>
                    <th class="py-3 px-4 font-medium">Book</th>
                    <th class="py-3 px-4 font-medium">Reserved On</th>
                    <th class="py-3 px-4 font-medium">Status</th>
                    <th class="py-3 px-4 font-medium text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="text-gray-200">
                {% if reserve_list|length > 0 %}
                    {% for reserve in reserve_list %}
                    <tr class="table-row border-b border-gray-700/40 last:border-none">
                        <td class="px-4 py-3 align-top">{{ forloop.counter }}</td>
                        <td class="px-4 py-3 align-top">{{ reserve.member.username }}</td>
                        <td class="px-4 py-3 align-top font-semibold">{{ reserve.book.title }}</td>
                        <td class="px-4 py-3 align-top">{{ reserve.reservation_date }}</td>
                        <td class="px-4 py-3 align-top">
                            {% if reserve.status == 'waiting' %}
                            <span class="status-badge status-pending" style="background:rgba(255,200,0,.15);color:#F8D347">{{ reserve.status }}</span>
                            {% elif reserve.status == 'ready' %}
                            <span class="status-badge status-available">{{ reserve.status }}</span>
                            {% elif reserve.status == 'completed' %}
                            <span class="status-badge status-available" style="background:rgba(76,206,255,.15);color:#4CCEFF">{{ reserve.status }}</span>
                            {% elif reserve.status == 'cancelled' %}
                            <span class="status-badge status-borrowed" style="color:#FF6B6B;background:rgba(255,76,76,.15)">{{ reserve.status }}</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 align-top">
                            {% if reserve.status == 'ready' %}
                            <button data-reserve="{{ reserve.id }}"
                                class="btn-approve action-btn px-6 py-2 mx-auto text-white rounded-[3rem] max-w-[70%] bg-[#2C7852] font-medium text-xs block text-center cursor-pointer">Approve</button>
                            {% else %}
                            <span class="text-gray-400 font-medium block text-center">No actions</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                <tr>
                    <td colspan="6" class="text-center text-gray-400 py-8">No reservations found.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    const handleApproveReservation = async function (reserveId) {
        const reserve = reserveId
        const csrftoken = "{{ csrf_token }}"
        try {
            const res = await fetch(`http://127.0.0.1:8000/library/api/reservations/${reserve}/`, {
                method: "PATCH",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({ status: 'completed' }),
            })

            if (res.ok)
                location.reload()

            else {
                alert(await res.json())
                console.log(await res.json())
            }
        } catch (err) {
            alert(err.message)
            console.log(err.message)
        }
        console.log('Approve reservation ID:', reserveId)
    }
    if (document.querySelectorAll('.btn-approve').length) {
        document.querySelectorAll('.btn-approve').forEach(b => {
            b.addEventListener('click', () => handleApproveReservation(b.dataset.reserve))
        })
    }
</script>
{% endblock %}
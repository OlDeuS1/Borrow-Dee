{% extends 'layouts/admin_base.html' %}
{% load static %}
{% block title %}Book Management{% endblock %}

{% csrf_token %}
{% block sidebar %}
    {% with active_section='books' %}
        {% include 'layouts/admin_sidebar.html' %}
    {% endwith %}
{% endblock %}
{% block header %}
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 mb-10">
    <h1 class="text-4xl font-bold text-white">Book Management</h1>
    <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
        <form method="GET" class="relative flex-1 min-w-[260px]">
            <input name="search" id="search" value="{{ request.GET.search }}" type="text" placeholder="Search books..." class="search-input pr-12" />
            <button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">üîç</button>
        </form>
        <a href="{% url 'add_book' %}" class="view-more-btn px-8 py-3 text-white font-medium flex items-center justify-center gap-2">
            <span class="text-lg leading-none">Ôºã</span> Add Book
        </a>
    </div>
</div>
{% endblock %}
{% block content %}
<div class="dashboard-card p-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 divider pb-4">
        <h2 class="text-2xl font-semibold text-white">Books List</h2>
        <div class="flex gap-2 text-sm text-gray-400">
            <span><strong class="text-white">{{ book_total }}</strong> total</span>
            <span class="hidden sm:inline">‚Ä¢</span>
            <span><strong class="text-[#4CFFA6]">1</strong> available</span>
            <span class="hidden sm:inline">‚Ä¢</span>
            <span><strong class="text-[#FF6B6B]">1</strong> borrowed</span>
        </div>
    </div>
    <div class="overflow-x-auto -mx-4 md:mx-0">
        {% if books|length == 0 %}
            <p class="text-center text-white/75 py-8">No books available.</p>
        {% else %}
        <table class="min-w-full text-sm text-left">
            <thead class="text-gray-400 uppercase text-xs tracking-wider">
                <tr class="border-b border-gray-600/40">
                    <th class="py-3 px-4 font-medium">ID</th>
                    <th class="py-3 px-4 font-medium">Cover</th>
                    <th class="py-3 px-4 font-medium">Title</th>
                    <th class="py-3 px-4 font-medium">Authors</th>
                    <th class="py-3 px-4 font-medium">Categories</th>
                    <th class="py-3 px-4 font-medium">ISBN</th>
                    <th class="py-3 px-4 font-medium">Total Copies</th>
                    <th class="py-3 px-4 font-medium">Status</th>
                    <th class="py-3 px-4 font-medium text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="text-gray-200">
                {% for book in books %}
                <tr class="table-row border-b border-gray-700/40 last:border-none">
                    <td class="px-4 py-3 align-top align-middle">{{ book.id }}</td>
                    <td class="my-borrows__data py-8 align-middle">
                        <img class="w-[6rem] h-[8rem] object-cover"
                            src="{% if book.image %}{{ book.image.url }}{% else %}{% static 'images/No_image_available.svg' %}{% endif %}"
                            alt="{{ book.title }}">
                    </td>
                    <td class="px-4 py-3 font-semibold align-middle">{{ book.title }}</td>
                    <td class="px-4 py-3 align-middle">
                        <div class="space-y-1 flex flex-col gap-1">
                            {% for author in book.author.all %}
                                <span class="status-badge status-available self-start ">{{ author.name }}</span>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="px-4 py-3 align-middle">
                        <div class="space-y-1 flex flex-col gap-1">
                            {% for category in book.category.all %}
                                <span class="status-badge status-available self-start">{{ category.name }}</span>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="px-4 py-3 align-middle">{{ book.isbn_number }}</td>
                    <td class="px-4 py-3 align-top align-middle">{{ book.amount }}</td>
                    <td class="px-4 py-3 align-top align-middle">
                        {% if book.amount > 0 %}
                            <span class="status-badge status-available">Available</span>
                        {% else %}
                            <span class="status-badge status-borrowed">Unavailable</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 align-top text-right whitespace-nowrap align-middle">
                        <a href="{% url 'edit_book' book.id %}" class="action-btn text-yellow-400 hover:text-yellow-300 mr-3" title="Edit">‚úèÔ∏è</a>
                        <button class="action-btn text-red-500 hover:text-red-400 delete-btn" 
                                data-book-id="{{ book.id }}" 
                                data-book-title="{{ book.title }}"
                                data-delete-url="{% url 'book-delete' book.id %}"
                                title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="bg-[#2D2D2D] rounded-3xl p-8 max-w-md mx-4 relative shadow-2xl border border-gray-600/30">
        <!-- Modal Content -->
                <!-- Close Button -->
                <button id="closeModal"
                    class="absolute top-5 right-5 text-white/40 hover:text-white/60 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path
                            d="M12.8536 4.85355C13.0488 4.65829 13.0488 4.34171 12.8536 4.14645C12.6583 3.95118 12.3417 3.95118 12.1464 4.14645L8 8.29289L3.85355 4.14645C3.65829 3.95118 3.34171 3.95118 3.14645 4.14645C2.95118 4.34171 2.95118 4.65829 3.14645 4.85355L7.29289 9L3.14645 13.1464C2.95118 13.3417 2.95118 13.6583 3.14645 13.8536C3.34171 14.0488 3.65829 14.0488 3.85355 13.8536L8 9.70711L12.1464 13.8536C12.3417 14.0488 12.6583 14.0488 12.8536 13.8536C13.0488 13.6583 13.0488 13.3417 12.8536 13.1464L8.70711 9L12.8536 4.85355Z"
                            fill="currentColor" />
                    </svg>
                </button>

        <div class="text-center">
            <h2 class="text-2xl font-bold text-white mb-2">Are you sure?</h2>
            <p class="text-white/85 mb-6">
                The book "<span id="bookTitle" class="font-semibold"></span>" will be deleted.
            </p>
            
            <div class="flex gap-4 justify-center">
                <button onclick="closeModal()" class="px-8 py-3 rounded-full border-2 border-white/15 text-white hover:bg-white/10 transition-colors font-medium min-w-[84px]">
                    No
                </button>
                <a href="#" id="confirmDelete" class="px-8 py-3 rounded-full bg-red-500 hover:bg-red-600 text-white transition-colors font-medium min-w-[84px]">
                    Yes
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function openModal(bookTitle, deleteUrl) {
    document.getElementById('bookTitle').textContent = bookTitle;
    document.getElementById('confirmDelete').href = deleteUrl;
    document.getElementById('deleteModal').classList.remove('hidden');
    document.getElementById('deleteModal').classList.add('flex');
}

function closeModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.getElementById('deleteModal').classList.remove('flex');
}

// Simple event delegation
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('delete-btn')) {
        openModal(e.target.dataset.bookTitle, e.target.dataset.deleteUrl);
    }
});
</script>

{% endblock %}
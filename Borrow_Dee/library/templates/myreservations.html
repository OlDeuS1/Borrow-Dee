{% extends "layouts/layout.html" %}
{% load static %}

{% block title %} My Reservations {% endblock %}

{% block header %}
    {% include "layouts/navigation.html" %}
{% endblock %}

{% block content %}
    <div class="my-reservations">
      <h1 class="my-reservations__title text-[4.2rem] mb-25">My Reservations</h1>
      <div class="my-reservations__content">
        {% if reservations.count > 0 %}
          <table class="my-reservations__table border-collapse w-full">
            {% for reserve in reservations %}
              <tr class="my-reservations__row border-t border-gray-300 text-[1.6rem]">
                <td class="my-reservations__data py-8 align-middle">
                  <img class="w-[15rem]" src="{% if reserve.book.image %}{{ reserve.book.image.url }}{% else %}{% static 'images/No_image_available.svg' %}{% endif %}" alt="{{ reserve.book.title }}">
                </td>
                <td class="my-reservations__data py-8">
                  {{ reserve.book.title }}
                  <div class="text-gray-500 text-[1.4rem]">{{ reserve.book.author.all|join:", " }}</div>
                </td>
                <td class="my-reservations__data py-8">
                  Your Queue Position
                  <div class="text-gray-500 text-[1.4rem]">
                    {% if reserve.status == 'ready' %}
                      It's your turn.
                    {% elif reserve.status == 'completed' or reserve.status == 'cancelled' %}
                      -
                    {% else %} 
                      #{{ reserve.current_queue }}
                    {% endif %}
                  </div>
                </td>
                <td class="my-reservations__data py-8">
                  Reserved Date
                  <div class="text-gray-500 text-[1.4rem]">{{ reserve.reservation_date|date:"d F, Y" }}</div>
                </td>
                <td class="my-reservations__data py-8">
                  Status
                  <div class="text-gray-500 text-[1.4rem]">{{ reserve.status }}</div>
                </td>
                <td class="my-reservations__data py-8 text-center">
                  {% if reserve.status == 'cancelled' %}
                    <button disabled class="btn-cancel-reserve-disable inline-block text-gray-400 px-8 py-3 rounded-[3rem] border-2 border-gray-400 transition-all shadow-xl">
                      Cancel Reservation
                    </button>
                  {% else %} 
                    <button data-reserve="{{ reserve.id }}" class="btn-cancel-reserve hover:text-gray-700 hover:border-gray-700 inline-block cursor-pointer text-gray-500 px-8 py-3 rounded-[3rem] border-2 border-gray-500 transition-all shadow-xl">
                      Cancel Reservation
                    </button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </table>
        {% else %}
          <div class="text-center p-8 text-gray-400">No reservations yet.</div>
        {% endif %}
      </div>
    </div>
{% endblock %}
{% block script %}
    <script>
      const handleCancelReservation = async function(reserveId){
        const reserve = reserveId
        const csrftoken = "{{ csrf_token }}"
        try {
          const res = await fetch(`http://127.0.0.1:8000/library/api/reservations/${reserve}/`, {
            method: "PATCH",
            headers: { 
                      'Content-Type': 'application/json',
                      'X-CSRFToken': csrftoken,
                      },
            body: JSON.stringify({status: 'cancelled'}),
          })
          
          if(res.ok)
            location.reload()

          else {
            alert(await res.json())
            console.log(await res.json())
          }
        } catch(err) {
          alert(err.message)
          console.log(err.message)
        }
      }

      if(document.querySelectorAll('.btn-cancel-reserve').length) {
        document.querySelectorAll('.btn-cancel-reserve').forEach(b => {
          b.addEventListener('click', () => handleCancelReservation(b.dataset.reserve))
        })
      }
    </script>
{% endblock %}